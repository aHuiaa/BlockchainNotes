
var Web3 = require('web3');
var rp = require('request-promise');

/*************
** 参数配置 **
*************/
var appid = 'wxe2d66948fed96b28';//小程序ID
var secret = '567ad1ef9a59573df3e6539a4480fdd9';//小程序密钥
var adminAddress = '0x9418da32757a958aa43cb415f9edb80a5403007e';//管理员以太坊账户地址，即【adminAddress】
var httpProviderUrl = 'http://localhost:1111';//以太坊节点IP/端口，默认：http://localhost:1111	

var web3 = new Web3(new Web3.providers.HttpProvider(httpProviderUrl));

var jsonInterface = [{"constant":false,"inputs":[{"name":"id","type":"string"},{"name":"date","type":"string"},{"name":"title","type":"string"},{"name":"intro","type":"string"},{"name":"content","type":"string"}],"name":"addNote","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"date","type":"string"},{"name":"count","type":"uint256"}],"name":"getNoteList","outputs":[{"components":[{"name":"id","type":"string"},{"name":"title","type":"string"},{"name":"intro","type":"string"},{"name":"content","type":"string"}],"name":"","type":"tuple[]"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"date","type":"string"},{"name":"id","type":"string"}],"name":"getNote","outputs":[{"components":[{"name":"id","type":"string"},{"name":"title","type":"string"},{"name":"intro","type":"string"},{"name":"content","type":"string"}],"name":"","type":"tuple"}],"payable":false,"stateMutability":"view","type":"function"},{"inputs":[],"payable":false,"stateMutability":"nonpayable","type":"constructor"}];

//创建账号
async function createAccount(body) {
	var password = body.openid;
	var resultData = null;
	console.log("mima密码"+password);

	await web3.eth.personal.newAccount(password).then(function (result) {
		resultData = result;
		console.log("账户创建成功：" + resultData);

		getEth(resultData, '10');
	});

	return resultData;
}

//处理异步发布合约
async function deployContract(body) {

	var address = body.address;//账户地址
	var password = body.openid;

	var unlock = await unlockAccount(address, password);
	console.log('账户解锁结果：' + unlock);

	var result = await deploy(address);

	// return { contractAddress: result };
	return result;
}


//发布合约
function deploy(address) {
	var blocknoteContract = new web3.eth.Contract(jsonInterface);
	var data = '0x608060405234801561001057600080fd5b50336000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550611396806100606000396000f3fe608060405260043610610051576000357c010000000000000000000000000000000000000000000000000000000090048063a8e63de714610056578063bac407ff1461007f578063f947387c146100bc575b600080fd5b34801561006257600080fd5b5061007d60048036036100789190810190610f5b565b6100f9565b005b34801561008b57600080fd5b506100a660048036036100a1919081019061104a565b61037c565b6040516100b39190611232565b60405180910390f35b3480156100c857600080fd5b506100e360048036036100de9190810190610eef565b61093b565b6040516100f09190611254565b60405180910390f35b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614151561015457600080fd5b61015c610d0e565b608060405190810160405280878152602001858152602001848152602001838152509050806001866040518082805190602001908083835b6020831015156101b95780518252602082019150602081019050602083039250610194565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020876040518082805190602001908083835b60208310151561022257805182526020820191506020810190506020830392506101fd565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390206000820151816000019080519060200190610271929190610d37565b50602082015181600101908051906020019061028e929190610d37565b5060408201518160020190805190602001906102ab929190610d37565b5060608201518160030190805190602001906102c8929190610d37565b509050506002856040518082805190602001908083835b60208310151561030457805182526020820191506020810190506020830392506102df565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020869080600181540180825580915050906001820390600052602060002001600090919290919091509080519060200190610372929190610db7565b5050505050505050565b60606000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161415156103d957600080fd5b816002846040518082805190602001908083835b60208310151561041257805182526020820191506020810190506020830392506103ed565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390208054905010806104555750600082145b156104cc576002836040518082805190602001908083835b602083101515610492578051825260208201915060208101905060208303925061046d565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390208054905091505b60608260405190808252806020026020018201604052801561050857816020015b6104f5610e37565b8152602001906001900390816104ed5790505b50905060008090505b83811015610930576001856040518082805190602001908083835b602083101515610551578051825260208201915060208101905060208303925061052c565b6001836020036101000a03801982511681845116808217855250505050505090500191505090815260200160405180910390206002866040518082805190602001908083835b6020831015156105bc5780518252602082019150602081019050602083039250610597565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020828154811015156105fc57fe5b9060005260206000200160405180828054600181600116156101000203166002900480156106615780601f1061063f576101008083540402835291820191610661565b820191906000526020600020905b81548152906001019060200180831161064d575b5050915050908152602001604051809103902060806040519081016040529081600082018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156107195780601f106106ee57610100808354040283529160200191610719565b820191906000526020600020905b8154815290600101906020018083116106fc57829003601f168201915b50505050508152602001600182018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156107bb5780601f10610790576101008083540402835291602001916107bb565b820191906000526020600020905b81548152906001019060200180831161079e57829003601f168201915b50505050508152602001600282018054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561085d5780601f106108325761010080835404028352916020019161085d565b820191906000526020600020905b81548152906001019060200180831161084057829003601f168201915b50505050508152602001600382018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156108ff5780601f106108d4576101008083540402835291602001916108ff565b820191906000526020600020905b8154815290600101906020018083116108e257829003601f168201915b505050505081525050828281518110151561091657fe5b906020019060200201819052508080600101915050610511565b508091505092915050565b610943610d0e565b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614151561099e57600080fd5b6001836040518082805190602001908083835b6020831015156109d657805182526020820191506020810190506020830392506109b1565b6001836020036101000a0380198251168184511680821785525050505050509050019150509081526020016040518091039020826040518082805190602001908083835b602083101515610a3f5780518252602082019150602081019050602083039250610a1a565b6001836020036101000a038019825116818451168082178552505050505050905001915050908152602001604051809103902060806040519081016040529081600082018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610b175780601f10610aec57610100808354040283529160200191610b17565b820191906000526020600020905b815481529060010190602001808311610afa57829003601f168201915b50505050508152602001600182018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610bb95780601f10610b8e57610100808354040283529160200191610bb9565b820191906000526020600020905b815481529060010190602001808311610b9c57829003601f168201915b50505050508152602001600282018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610c5b5780601f10610c3057610100808354040283529160200191610c5b565b820191906000526020600020905b815481529060010190602001808311610c3e57829003601f168201915b50505050508152602001600382018054600181600116156101000203166002900480601f016020809104026020016040519081016040528092919081815260200182805460018160011615610100020316600290048015610cfd5780601f10610cd257610100808354040283529160200191610cfd565b820191906000526020600020905b815481529060010190602001808311610ce057829003601f168201915b505050505081525050905092915050565b608060405190810160405280606081526020016060815260200160608152602001606081525090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10610d7857805160ff1916838001178555610da6565b82800160010185558215610da6579182015b82811115610da5578251825591602001919060010190610d8a565b5b509050610db39190610e60565b5090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10610df857805160ff1916838001178555610e26565b82800160010185558215610e26579182015b82811115610e25578251825591602001919060010190610e0a565b5b509050610e339190610e60565b5090565b608060405190810160405280606081526020016060815260200160608152602001606081525090565b610e8291905b80821115610e7e576000816000905550600101610e66565b5090565b90565b600082601f8301121515610e9857600080fd5b8135610eab610ea6826112a3565b611276565b91508082526020830160208301858383011115610ec757600080fd5b610ed2838284611309565b50505092915050565b6000610ee782356112ff565b905092915050565b60008060408385031215610f0257600080fd5b600083013567ffffffffffffffff811115610f1c57600080fd5b610f2885828601610e85565b925050602083013567ffffffffffffffff811115610f4557600080fd5b610f5185828601610e85565b9150509250929050565b600080600080600060a08688031215610f7357600080fd5b600086013567ffffffffffffffff811115610f8d57600080fd5b610f9988828901610e85565b955050602086013567ffffffffffffffff811115610fb657600080fd5b610fc288828901610e85565b945050604086013567ffffffffffffffff811115610fdf57600080fd5b610feb88828901610e85565b935050606086013567ffffffffffffffff81111561100857600080fd5b61101488828901610e85565b925050608086013567ffffffffffffffff81111561103157600080fd5b61103d88828901610e85565b9150509295509295909350565b6000806040838503121561105d57600080fd5b600083013567ffffffffffffffff81111561107757600080fd5b61108385828601610e85565b925050602061109485828601610edb565b9150509250929050565b60006110a9826112dc565b808452602084019350836020820285016110c2856112cf565b60005b848110156110fb5783830388526110dd8383516111ba565b92506110e8826112f2565b91506020880197506001810190506110c5565b508196508694505050505092915050565b6000611117826112e7565b80845261112b816020860160208601611318565b6111348161134b565b602085010191505092915050565b6000608083016000830151848203600086015261115f828261110c565b91505060208301518482036020860152611179828261110c565b91505060408301518482036040860152611193828261110c565b915050606083015184820360608601526111ad828261110c565b9150508091505092915050565b600060808301600083015184820360008601526111d7828261110c565b915050602083015184820360208601526111f1828261110c565b9150506040830151848203604086015261120b828261110c565b91505060608301518482036060860152611225828261110c565b9150508091505092915050565b6000602082019050818103600083015261124c818461109e565b905092915050565b6000602082019050818103600083015261126e8184611142565b905092915050565b6000604051905081810181811067ffffffffffffffff8211171561129957600080fd5b8060405250919050565b600067ffffffffffffffff8211156112ba57600080fd5b601f19601f8301169050602081019050919050565b6000602082019050919050565b600081519050919050565b600081519050919050565b6000602082019050919050565b6000819050919050565b82818337600083830152505050565b60005b8381101561133657808201518184015260208101905061131b565b83811115611345576000848401525b50505050565b6000601f19601f830116905091905056fea265627a7a72305820feb327466c3f2f68a61e5e531336f243a6479a1233422b5913e2d6a9b59f102f6c6578706572696d656e74616cf50037';
	var contractAddress = null;//新合约地址

	//部署合约
	return new Promise(function (resolve, reject) {
		blocknoteContract.deploy({
			data: data
		})
			.send({
				from: address,
				gas: 3000000,
				gasPrice: '30'
			}, function (error, transactionHash) {
				//console.log(error);

			})
			.on('receipt', function (receipt) {
				console.log('合约部署地址：' + receipt.contractAddress) // 收据中包含了新的合约地址

				resolve(receipt.contractAddress);
			});
	});
}

//添加笔记
async function createNote(body) {
	if (body == undefined) {
		return '{error:true}';
	}
	var address = body.address;
	var contractAddress = body.contractAddress;
	var title = body.title;
	var intro = body.intro;
	var content = body.content;
	var password = body.openid;

	var unlock = await unlockAccount(address, password);
	var redata = null;

	var blocknoteContract = new web3.eth.Contract(jsonInterface, contractAddress);
	await blocknoteContract.methods.addNote(web3.utils.sha3(content + (new Date()).getTime()), getNowFormatDate(), title, intro, content).send({
		from: address,
		gas: 3000000,
		gasPrice: '3'
	}, function (error, result) {
		redata = { 'error': error, 'result': result };
	});
	console.log("这里运行到了");
	console.log(redata);
	return redata;
}

//查询笔记列表
async function getNoteList(body) {
	if (body == undefined) {
		return '{error:true}';
	}
	var address = body.address;
	var contractAddress = body.contractAddress;
	var count = body.count;
	var date = body.date;

	var redata = null;

	var blocknoteContract = new web3.eth.Contract(jsonInterface, contractAddress);
	await blocknoteContract.methods.getNoteList(date, count).call({
		from: address
	}, function (error, result) {
		console.log(error);
		console.log(result)
		redata = { 'error': error, 'result': result };
	});
	return redata;

}

//查询单个笔记
async function getNote(body) {
	if (body == undefined) {
		return '{error:true}';
	}
	var address = body.address;
	var contractAddress = body.contractAddress;
	var date = body.date;
	var id = body.id;
	console.log(address);
	console.log(contractAddress);
	console.log(date);
	console.log(id);

	var redata = null;

	var blocknoteContract = new web3.eth.Contract(jsonInterface, contractAddress);
	await blocknoteContract.methods.getNote(date, id).call({
		from: address
	}, function (error, result) {
		
		redata = { 'error': error, 'result': result };
	});
	return redata;
	// return result;

}

//根据用户登录小程序得到的code，获取用户的openid
async function code2Session(body) {
	var returnData = null;
	var code = body.code;
	console.log("code"+code)
	var requrl = "https://api.weixin.qq.com/sns/jscode2session?appid=" + appid + "&secret=" + secret + "&js_code=" + code + "&grant_type=authorization_code";
	await rp(requrl).then(function (data) {
		//console.log(data);
		returnData = data;
	}).catch(function (err) {
		console.log('err:' + err.stack);
	});
	return returnData;
}

//解锁账户
async function unlockAccount(address, password) {
	console.log('账户解锁中');
	console.log('address：' + address);
	console.log('password：' + password);
	var data = null;
	await web3.eth.personal.unlockAccount(address, password, 600).then(function (result) {
		data = result;
	});
	return data;
}

//获得以太币，每次获取1个以太币
async function getEth(address, value) {
	var result = await unlockAccount(adminAddress, "123456");

	web3.eth.personal.sendTransaction({
		from: adminAddress,
		to: address,
		value: web3.eth.utils.toWei(value)
	},'123456').then(function (res) {
		console.log('获取以太币的转账交易Hash值：' + res);
	});

}

//查询账户余额
async function getBalance(body) {
	var address = body.address;
	var result = false;
	await web3.eth.getBalance(address).then(function (res) {
		var balance = web3.utils.fromWei(res);
		console.log('账户' + address + '余额:' + balance + ' ether');
		if (balance >= 1) {
			result = true;
		}
	});
	return result;
}

//获取当前时间，格式YYYY-MM-DD
function getNowFormatDate() {
	var date = new Date();
	var seperator1 = "-";
	var year = date.getFullYear();
	var month = date.getMonth() + 1;
	var strDate = date.getDate();
	if (month >= 1 && month <= 9) {
		month = "0" + month;
	}
	if (strDate >= 0 && strDate <= 9) {
		strDate = "0" + strDate;
	}
	var currentdate = year + seperator1 + month + seperator1 + strDate;
	console.log(currentdate);
	return currentdate;
}

//查询话题列表（社区模块）
function query(body) {

	var promise = new Promise(function (resolve, reject) {
		var mysql = require('mysql');
		var connection = mysql.createConnection({
			host: 'localhost',
			user: 'root',
			password: '123',
			port: '3306',
			database: 'cloudnote'
		});
		connection.connect();
		var  userGetSql = 'SELECT * FROM note ORDER BY id DESC';
		connection.query(
			userGetSql,
			function selectCb(err, results) {
				if (results) {
					console.log(results);
					//resolve(results);
					resolve(results);
				}
				if (err) {
					console.log(err);
				}
				connection.end();
			}
		);
	  });
	  promise.then(function (value) {
		console.log(value);
		return value;
		// success
	  }, function (value) {
		// failure
	  });
	  return promise;
}
//查询话题（社区模块）
function gettopic(body) {

	var promise = new Promise(function (resolve, reject) {
		var mysql = require('mysql');
		var connection = mysql.createConnection({
			host: 'localhost',
			user: 'root',
			password: '123',
			port: '3306',
			database: 'cloudnote'
		});
		connection.connect();
		var  userGetSql = 'SELECT * FROM note WHERE id ='+body.id+' ORDER BY id';
		connection.query(
			userGetSql,
			function selectCb(err, results) {
				if (results) {
					console.log(results);
					//resolve(results);
					resolve(results);
				}
				if (err) {
					console.log(err);
				}
				connection.end();
			}
		);
	  });
	  promise.then(function (value) {
		console.log(value);
		return value;
		// success
	  }, function (value) {
		// failure
	  });
	  console.log("zheli格式"+promise);
	  return  promise;
}
//社区模块增加话题
function add(body){
	
	var promise = new Promise(function (resolve, reject) {
		var mysql = require('mysql');
		var connection = mysql.createConnection({
			host: 'localhost',
			user: 'root',
			password: '123',
			port: '3306',
			database: 'cloudnote'
		});
		connection.connect();
		var time = getNowFormatDate();
		var  userAddSql = 'INSERT INTO note(id,user_id,title,intro,text,date) VALUES(?,?,?,?,?,?)';
	    var  userAddSql_Params = [null,body.user_id, body.title,body.intro,body.content,time];
		connection.query(
			userAddSql,userAddSql_Params,
			function selectCb(err, results) {
				if (results) {
					console.log(results);
					//resolve(results);
					resolve(results);
				}
				if (err) {
					console.log(err);
				}
				connection.end();
			}
		);
	  });
	  promise.then(function (value) {
		console.log(value);
		return value;
		// success
	  }, function (value) {
		// failure
	  });
	  console.log("zheli格式"+promise);
	  return  promise;
	}

exports.createAccount = createAccount;
exports.deployContract = deployContract;
exports.createNote = createNote;
exports.getNoteList = getNoteList;
exports.getNote = getNote;
exports.code2Session = code2Session;
exports.getBalance = getBalance;
exports.getNowFormatDate = getNowFormatDate;
exports.query = query;
exports.gettopic = gettopic;
exports.add = add;

